<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#1976d2">
    <title>Tax Analytics - Finnish Wealth Tracker</title>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Google Fonts - Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/material-design.css">
    <link rel="stylesheet" href="css/material-forms.css">
    <link rel="stylesheet" href="css/material-dashboard.css">
</head>
<body>
    <!-- Material Design App Bar -->
    <header class="md-app-bar md-elevation-2">
        <button class="md-icon-button" onclick="toggleDrawer()">
            <span class="material-icons">menu</span>
        </button>
        <h1 class="md-app-bar-title">Tax Analytics</h1>
        <div style="flex: 1;"></div>
        <button class="md-icon-button" onclick="toggleSearch()">
            <span class="material-icons">search</span>
        </button>
        <button class="md-icon-button" onclick="showNotifications()">
            <span class="material-icons">notifications</span>
        </button>
        <button class="md-icon-button" onclick="toggleTheme()">
            <span class="material-icons">dark_mode</span>
        </button>
    </header>

    <!-- Search Bar (Hidden by default) -->
    <div class="md-search-bar" id="searchBar" style="display: none;">
        <div class="md-search-container">
            <span class="material-icons">search</span>
            <input type="text" placeholder="Search tax topics, calculations..." class="md-search-input">
            <button class="md-icon-button" onclick="toggleSearch()">
                <span class="material-icons">close</span>
            </button>
        </div>
    </div>

    <!-- Navigation Drawer -->
    <nav class="md-drawer" id="drawer">
        <div class="md-drawer-header">
            <img src="https://ui-avatars.com/api/?name=FW&background=1976d2&color=fff&size=64" alt="Avatar" class="drawer-avatar">
            <div class="drawer-user-info">
                <div class="drawer-user-name">Finnish Wealth Tracker</div>
                <div class="drawer-user-email">Building wealth in Finland</div>
            </div>
        </div>
        <div class="md-drawer-content">
            <a href="dashboard-material.html" class="md-drawer-item">
                <span class="material-icons">dashboard</span>
                Dashboard
            </a>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">account_balance_wallet</span>
                Portfolio
            </a>
            <a href="#" class="md-drawer-item active">
                <span class="material-icons">analytics</span>
                Tax Analytics
            </a>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">calculate</span>
                Tax Optimizer
            </a>
            <div class="md-drawer-divider"></div>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">menu_book</span>
                Investment Bible
            </a>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">language</span>
                Bicultural Mode
            </a>
            <div class="md-drawer-divider"></div>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">settings</span>
                Settings
            </a>
            <a href="#" class="md-drawer-item">
                <span class="material-icons">help</span>
                Help & Support
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="md-content">
        <!-- Tax Overview Section -->
        <section class="dashboard-section">
            <h2 class="section-title">Tax Overview</h2>
            <div class="metric-grid">
                <!-- OST Account Status -->
                <div class="md-card md-elevation-1 metric-card">
                    <div class="metric-header">
                        <div class="metric-icon warning">
                            <span class="material-icons">account_balance</span>
                        </div>
                        <button class="md-icon-button metric-menu">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">OST Account</div>
                        <div class="metric-value" id="ostUtilized">‚Ç¨22,500</div>
                        <div class="metric-subvalue" id="ostRemaining">‚Ç¨27,500 remaining</div>
                    </div>
                    <div class="metric-progress">
                        <div class="md-progress-linear">
                            <div class="md-progress-linear-bar warning" id="ostProgressBar" style="width: 45%;"></div>
                        </div>
                        <div class="progress-label" id="ostProgressLabel">45% of ‚Ç¨50,000 limit</div>
                    </div>
                </div>

                <!-- AOT Account Status -->
                <div class="md-card md-elevation-1 metric-card">
                    <div class="metric-header">
                        <div class="metric-icon primary">
                            <span class="material-icons">trending_up</span>
                        </div>
                        <button class="md-icon-button metric-menu">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">AOT Account</div>
                        <div class="metric-value" id="aotValue">‚Ç¨102,930</div>
                        <div class="metric-subvalue">Taxable investments</div>
                    </div>
                    <div class="metric-chips">
                        <span class="md-chip">30% Tax Rate</span>
                        <span class="md-chip">‚Ç¨5,146 Annual Tax</span>
                    </div>
                </div>

                <!-- Tax Efficiency Score -->
                <div class="md-card md-elevation-1 metric-card">
                    <div class="metric-header">
                        <div class="metric-icon success">
                            <span class="material-icons">insights</span>
                        </div>
                        <button class="md-icon-button metric-menu">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Tax Efficiency</div>
                        <div class="metric-value">8.5/10</div>
                        <div class="metric-change positive">
                            <span class="material-icons">trending_up</span>
                            +0.8 this month
                        </div>
                    </div>
                </div>

                <!-- Potential Savings -->
                <div class="md-card md-elevation-1 metric-card">
                    <div class="metric-header">
                        <div class="metric-icon info">
                            <span class="material-icons">savings</span>
                        </div>
                        <button class="md-icon-button metric-menu">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                    <div class="metric-content">
                        <div class="metric-label">Potential Tax Savings</div>
                        <div class="metric-value">‚Ç¨8,235</div>
                        <div class="metric-subvalue">Per year with optimization</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tax Optimization Recommendations -->
        <section class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">Optimization Recommendations</h2>
                <button class="md-button md-button-text">
                    View All Strategies
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
            <div class="recommendations-grid">
                <div class="md-card md-elevation-1 recommendation-card">
                    <div class="recommendation-header">
                        <div class="recommendation-icon high-impact">
                            <span class="material-icons">priority_high</span>
                        </div>
                        <div class="recommendation-priority">High Impact</div>
                    </div>
                    <div class="recommendation-content">
                        <h3 class="recommendation-title">Maximize OST Contribution</h3>
                        <p class="recommendation-description">
                            You have ‚Ç¨27,500 remaining in your OST allowance. Consider moving high-growth investments to OST for tax-deferred growth.
                        </p>
                        <div class="recommendation-savings">
                            <span class="material-icons">savings</span>
                            Potential savings: ‚Ç¨4,125/year (15% tax deferral)
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="md-button md-button-filled" onclick="openOSTInvestmentModal()">
                            <span class="material-icons">add</span>
                            Add OST Investment
                        </button>
                        <button class="md-button md-button-text" onclick="showOSTLearnMore()">Learn More</button>
                    </div>
                </div>

                <div class="md-card md-elevation-1 recommendation-card">
                    <div class="recommendation-header">
                        <div class="recommendation-icon medium-impact">
                            <span class="material-icons">trending_up</span>
                        </div>
                        <div class="recommendation-priority">Medium Impact</div>
                    </div>
                    <div class="recommendation-content">
                        <h3 class="recommendation-title">Tax-Loss Harvesting</h3>
                        <p class="recommendation-description">
                            Consider selling underperforming AOT investments to offset capital gains and reduce your tax burden.
                        </p>
                        <div class="recommendation-savings">
                            <span class="material-icons">savings</span>
                            Potential savings: ‚Ç¨1,850/year
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="md-button md-button-outlined" onclick="analyzeTaxLossHarvesting()">
                            <span class="material-icons">analytics</span>
                            Analyze Holdings
                        </button>
                        <button class="md-button md-button-text" onclick="showTaxLossLearnMore()">Learn More</button>
                    </div>
                </div>

                <div class="md-card md-elevation-1 recommendation-card">
                    <div class="recommendation-header">
                        <div class="recommendation-icon low-impact">
                            <span class="material-icons">info</span>
                        </div>
                        <div class="recommendation-priority">Low Impact</div>
                    </div>
                    <div class="recommendation-content">
                        <h3 class="recommendation-title">Dividend Timing</h3>
                        <p class="recommendation-description">
                            Consider timing dividend-paying stock purchases to optimize tax efficiency across tax years.
                        </p>
                        <div class="recommendation-savings">
                            <span class="material-icons">savings</span>
                            Potential savings: ‚Ç¨320/year
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="md-button md-button-outlined" onclick="showDividendCalendar()">
                            <span class="material-icons">schedule</span>
                            View Calendar
                        </button>
                        <button class="md-button md-button-text" onclick="showDividendLearnMore()">Learn More</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tax Breakdown Chart -->
        <section class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">Tax Breakdown</h2>
                <button class="md-button md-button-text">
                    Export Report
                    <span class="material-icons">download</span>
                </button>
            </div>
            <div class="md-card md-elevation-2">
                <div class="tax-breakdown-container">
                    <div class="tax-chart">
                        <canvas id="taxBreakdownChart"></canvas>
                    </div>
                    <div class="tax-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #1976d2;"></span>
                            <span class="legend-label">OST (Tax-deferred)</span>
                            <span class="legend-value">‚Ç¨22,500</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #00897b;"></span>
                            <span class="legend-label">AOT (Taxable)</span>
                            <span class="legend-value">‚Ç¨102,930</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #f57c00;"></span>
                            <span class="legend-label">Annual Tax Burden</span>
                            <span class="legend-value">‚Ç¨5,146</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #7b1fa2;"></span>
                            <span class="legend-label">Tax Savings (OST)</span>
                            <span class="legend-value">‚Ç¨3,375</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent Tax Activities -->
        <section class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">Recent Tax Activities</h2>
                <button class="md-button md-button-text">
                    View All
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
            <div class="md-card md-elevation-1">
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon success">
                            <span class="material-icons">account_balance</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">OST Contribution</div>
                            <div class="activity-subtitle">Added VWCE ETF to OST account</div>
                        </div>
                        <div class="activity-meta">
                            <div class="activity-amount">‚Ç¨5,000</div>
                            <div class="activity-time">2 days ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon warning">
                            <span class="material-icons">analytics</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Tax Optimization Alert</div>
                            <div class="activity-subtitle">OST utilization increased to 45%</div>
                        </div>
                        <div class="activity-meta">
                            <div class="activity-amount">+3%</div>
                            <div class="activity-time">2 days ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon info">
                            <span class="material-icons">description</span>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Tax Report Generated</div>
                            <div class="activity-subtitle">Q4 2024 Tax Summary</div>
                        </div>
                        <div class="activity-meta">
                            <div class="activity-amount">PDF</div>
                            <div class="activity-time">1 week ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="md-bottom-nav">
        <a href="dashboard-material.html" class="md-bottom-nav-item">
            <span class="material-icons">dashboard</span>
            <span class="nav-label">Dashboard</span>
        </a>
        <a href="#" class="md-bottom-nav-item">
            <span class="material-icons">pie_chart</span>
            <span class="nav-label">Portfolio</span>
        </a>
        <a href="#" class="md-bottom-nav-item active">
            <span class="material-icons">insights</span>
            <span class="nav-label">Analytics</span>
        </a>
        <a href="#" class="md-bottom-nav-item">
            <span class="material-icons">more_horiz</span>
            <span class="nav-label">More</span>
        </a>
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize ripple effects
        document.querySelectorAll('.md-button, .md-icon-button, .recommendation-card').forEach(element => {
            element.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.classList.add('md-ripple');
                
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                this.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            });
        });

        // Drawer functionality
        function toggleDrawer() {
            const drawer = document.getElementById('drawer');
            drawer.classList.toggle('open');
            
            // Add overlay
            let overlay = document.querySelector('.drawer-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'drawer-overlay';
                overlay.onclick = toggleDrawer;
                document.body.appendChild(overlay);
            }
            overlay.classList.toggle('show');
        }

        // Search functionality
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
            if (searchBar.style.display === 'block') {
                searchBar.querySelector('input').focus();
            }
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            
            // Update icon
            const icon = document.querySelector('.md-app-bar .md-icon-button:nth-last-child(1) .material-icons');
            icon.textContent = newTheme === 'dark' ? 'light_mode' : 'dark_mode';
        }

        // Notifications placeholder
        function showNotifications() {
            alert('Notifications coming soon!');
        }

        // Initialize tax breakdown chart
        const ctx = document.getElementById('taxBreakdownChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OST (Tax-deferred)', 'AOT (Taxable)', 'Annual Tax Burden', 'Tax Savings (OST)'],
                datasets: [{
                    data: [22500, 102930, 5146, 3375],
                    backgroundColor: ['#1976d2', '#00897b', '#f57c00', '#7b1fa2'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Tax Analytics Functions
        class FinnishTaxCalculator {
            constructor() {
                this.OST_LIMIT = 50000; // Annual OST contribution limit
                this.CAPITAL_GAINS_TAX_RATE = 0.30; // 30% capital gains tax
                this.DIVIDEND_TAX_RATE = 0.30; // 30% dividend tax
                this.OST_TAX_RATE = 0.15; // 15% tax on OST withdrawals after age 68
                this.currentYear = new Date().getFullYear();
            }

            // Get investment data from localStorage (Phase 1 integration)
            getInvestmentData() {
                const defaultData = {
                    ostInvestments: [
                        { type: 'etf', symbol: 'VWCE', amount: 15000, purchaseDate: '2024-01-15', currentValue: 16800 },
                        { type: 'stock', symbol: 'MSFT', amount: 7500, purchaseDate: '2024-03-20', currentValue: 8200 }
                    ],
                    aotInvestments: [
                        { type: 'etf', symbol: 'VTI', amount: 45000, purchaseDate: '2023-06-10', currentValue: 52000 },
                        { type: 'stock', symbol: 'AAPL', amount: 25000, purchaseDate: '2023-09-15', currentValue: 28500 },
                        { type: 'stock', symbol: 'GOOGL', amount: 18000, purchaseDate: '2024-02-01', currentValue: 19800 },
                        { type: 'fixed-deposit', bank: 'Nordea', amount: 5000, rate: 3.2, maturityDate: '2025-01-01' }
                    ]
                };

                try {
                    return JSON.parse(localStorage.getItem('investmentData')) || defaultData;
                } catch {
                    return defaultData;
                }
            }

            // Calculate OST utilization
            calculateOSTStatus() {
                const data = this.getInvestmentData();
                const ostTotal = data.ostInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const remaining = this.OST_LIMIT - ostTotal;
                const percentage = (ostTotal / this.OST_LIMIT * 100);

                return {
                    utilized: ostTotal,
                    remaining: Math.max(0, remaining),
                    percentage: Math.min(100, percentage),
                    currentValue: data.ostInvestments.reduce((sum, inv) => sum + inv.currentValue, 0)
                };
            }

            // Calculate AOT summary
            calculateAOTStatus() {
                const data = this.getInvestmentData();
                const aotTotal = data.aotInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const currentValue = data.aotInvestments.reduce((sum, inv) => sum + (inv.currentValue || inv.amount), 0);
                const unrealizedGains = currentValue - aotTotal;
                const annualTaxBurden = this.calculateAnnualTax(data.aotInvestments);

                return {
                    invested: aotTotal,
                    currentValue: currentValue,
                    unrealizedGains: unrealizedGains,
                    annualTax: annualTaxBurden,
                    effectiveTaxRate: aotTotal > 0 ? (annualTaxBurden / aotTotal * 100) : 0
                };
            }

            // Calculate annual tax burden for AOT investments
            calculateAnnualTax(aotInvestments) {
                let totalTax = 0;
                
                aotInvestments.forEach(investment => {
                    if (investment.currentValue && investment.amount) {
                        // Calculate unrealized gains tax (simplified)
                        const gains = investment.currentValue - investment.amount;
                        if (gains > 0) {
                            totalTax += gains * this.CAPITAL_GAINS_TAX_RATE;
                        }
                    }
                    
                    // Add estimated dividend tax for stocks/ETFs
                    if (investment.type === 'stock' || investment.type === 'etf') {
                        const estimatedDividendYield = 0.02; // 2% average dividend yield
                        const estimatedDividends = investment.currentValue * estimatedDividendYield;
                        totalTax += estimatedDividends * this.DIVIDEND_TAX_RATE;
                    }
                });

                return totalTax;
            }

            // Calculate tax efficiency score (0-10)
            calculateTaxEfficiency() {
                const ostStatus = this.calculateOSTStatus();
                const aotStatus = this.calculateAOTStatus();
                const totalPortfolio = ostStatus.currentValue + aotStatus.currentValue;
                
                if (totalPortfolio === 0) return 0;

                // Factors for tax efficiency
                const ostUtilizationScore = Math.min(10, (ostStatus.percentage / 100) * 10); // Max 10 points for full OST utilization
                const ostAllocationScore = (ostStatus.currentValue / totalPortfolio) * 5; // Max 5 points for OST allocation
                const taxBurdenScore = Math.max(0, 5 - (aotStatus.annualTax / totalPortfolio * 100)); // Max 5 points for low tax burden

                const totalScore = ostUtilizationScore + ostAllocationScore + taxBurdenScore;
                return Math.min(10, Math.max(0, totalScore));
            }

            // Calculate potential tax savings with optimization
            calculatePotentialSavings() {
                const ostStatus = this.calculateOSTStatus();
                const aotStatus = this.calculateAOTStatus();
                
                let potentialSavings = 0;

                // Savings from maximizing OST
                if (ostStatus.remaining > 0) {
                    const potentialOSTContribution = Math.min(ostStatus.remaining, aotStatus.currentValue * 0.5);
                    potentialSavings += potentialOSTContribution * this.CAPITAL_GAINS_TAX_RATE;
                }

                // Savings from tax-loss harvesting (estimated)
                const aotGains = aotStatus.unrealizedGains;
                if (aotGains > 0) {
                    const potentialLossHarvesting = aotGains * 0.1; // Assume 10% can be offset
                    potentialSavings += potentialLossHarvesting * this.CAPITAL_GAINS_TAX_RATE;
                }

                return potentialSavings;
            }

            // Generate personalized recommendations
            generateRecommendations() {
                const ostStatus = this.calculateOSTStatus();
                const aotStatus = this.calculateAOTStatus();
                const recommendations = [];

                // OST maximization recommendation
                if (ostStatus.remaining > 1000) {
                    const potential = Math.min(ostStatus.remaining, 10000);
                    const savings = potential * this.CAPITAL_GAINS_TAX_RATE;
                    recommendations.push({
                        type: 'high-impact',
                        title: 'Maximize OST Contribution',
                        description: `You have ‚Ç¨${ostStatus.remaining.toLocaleString()} remaining in your OST allowance. Consider moving high-growth investments to OST for tax-deferred growth.`,
                        savings: savings,
                        action: 'Add OST Investment'
                    });
                }

                // Tax-loss harvesting
                if (aotStatus.unrealizedGains > 2000) {
                    const harvestable = aotStatus.unrealizedGains * 0.15;
                    const savings = harvestable * this.CAPITAL_GAINS_TAX_RATE;
                    recommendations.push({
                        type: 'medium-impact',
                        title: 'Tax-Loss Harvesting',
                        description: 'Consider selling underperforming AOT investments to offset capital gains and reduce your tax burden.',
                        savings: savings,
                        action: 'Analyze Holdings'
                    });
                }

                // Dividend optimization
                if (aotStatus.currentValue > 50000) {
                    const dividendTax = aotStatus.currentValue * 0.02 * this.DIVIDEND_TAX_RATE;
                    const savings = dividendTax * 0.2;
                    recommendations.push({
                        type: 'low-impact',
                        title: 'Dividend Timing',
                        description: 'Consider timing dividend-paying stock purchases to optimize tax efficiency across tax years.',
                        savings: savings,
                        action: 'View Calendar'
                    });
                }

                return recommendations;
            }
        }

        // Initialize tax calculator
        const taxCalculator = new FinnishTaxCalculator();

        function updateTaxAnalytics() {
            // Update OST status
            const ostStatus = taxCalculator.calculateOSTStatus();
            document.getElementById('ostUtilized').textContent = `‚Ç¨${ostStatus.utilized.toLocaleString()}`;
            document.getElementById('ostRemaining').textContent = `‚Ç¨${ostStatus.remaining.toLocaleString()} remaining`;
            document.getElementById('ostProgressBar').style.width = `${ostStatus.percentage.toFixed(0)}%`;
            document.getElementById('ostProgressLabel').textContent = `${ostStatus.percentage.toFixed(0)}% of ‚Ç¨${taxCalculator.OST_LIMIT.toLocaleString()} limit`;

            // Update AOT status
            const aotStatus = taxCalculator.calculateAOTStatus();
            document.getElementById('aotValue').textContent = `‚Ç¨${aotStatus.currentValue.toLocaleString()}`;
            
            // Update tax efficiency
            const efficiency = taxCalculator.calculateTaxEfficiency();
            document.querySelector('.metric-card:nth-child(3) .metric-value').textContent = `${efficiency.toFixed(1)}/10`;
            
            // Update potential savings
            const savings = taxCalculator.calculatePotentialSavings();
            document.querySelector('.metric-card:nth-child(4) .metric-value').textContent = `‚Ç¨${savings.toLocaleString()}`;

            // Update recommendations
            updateRecommendations();

            // Update chart with real data
            updateTaxChart(ostStatus, aotStatus);
        }

        function updateRecommendations() {
            const recommendations = taxCalculator.generateRecommendations();
            const container = document.querySelector('.recommendations-grid');
            
            container.innerHTML = recommendations.map((rec, index) => `
                <div class="md-card md-elevation-1 recommendation-card">
                    <div class="recommendation-header">
                        <div class="recommendation-icon ${rec.type}">
                            <span class="material-icons">${rec.type === 'high-impact' ? 'priority_high' : rec.type === 'medium-impact' ? 'trending_up' : 'info'}</span>
                        </div>
                        <div class="recommendation-priority">${rec.type.replace('-', ' ')}</div>
                    </div>
                    <div class="recommendation-content">
                        <h3 class="recommendation-title">${rec.title}</h3>
                        <p class="recommendation-description">${rec.description}</p>
                        <div class="recommendation-savings">
                            <span class="material-icons">savings</span>
                            Potential savings: ‚Ç¨${rec.savings.toLocaleString()}/year
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="md-button ${rec.type === 'high-impact' ? 'md-button-filled' : 'md-button-outlined'}">
                            <span class="material-icons">${rec.type === 'high-impact' ? 'add' : rec.type === 'medium-impact' ? 'analytics' : 'schedule'}</span>
                            ${rec.action}
                        </button>
                        <button class="md-button md-button-text">Learn More</button>
                    </div>
                </div>
            `).join('');
        }

        function updateTaxChart(ostStatus, aotStatus) {
            const ctx = document.getElementById('taxBreakdownChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.taxChart) {
                window.taxChart.destroy();
            }
            
            window.taxChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['OST (Tax-deferred)', 'AOT (Taxable)', 'Annual Tax Burden', 'Tax Savings (OST)'],
                    datasets: [{
                        data: [
                            ostStatus.currentValue,
                            aotStatus.currentValue,
                            aotStatus.annualTax,
                            ostStatus.currentValue * 0.15 // Estimated OST tax savings
                        ],
                        backgroundColor: ['#1976d2', '#00897b', '#f57c00', '#7b1fa2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Update legend with real data
            const legendItems = document.querySelectorAll('.tax-legend .legend-item');
            const values = [
                `‚Ç¨${ostStatus.currentValue.toLocaleString()}`,
                `‚Ç¨${aotStatus.currentValue.toLocaleString()}`,
                `‚Ç¨${aotStatus.annualTax.toLocaleString()}`,
                `‚Ç¨${(ostStatus.currentValue * 0.15).toLocaleString()}`
            ];
            legendItems.forEach((item, index) => {
                const valueSpan = item.querySelector('.legend-value');
                if (valueSpan) valueSpan.textContent = values[index];
            });
        }

        // Recommendation Action Handlers
        function openOSTInvestmentModal() {
            // Check if investment modal exists from Phase 1
            const modal = document.getElementById('investmentModal');
            if (modal) {
                // Pre-select OST account type
                const ostOption = document.querySelector('input[name="accountType"][value="ost"]');
                if (ostOption) ostOption.checked = true;
                
                // Show modal
                modal.style.display = 'flex';
                modal.classList.add('open');
                
                // Focus on investment type selection
                const investmentTypes = document.querySelector('.investment-type-grid');
                if (investmentTypes) {
                    investmentTypes.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                // Fallback: redirect to dashboard with OST preselected
                const url = new URL(window.location.origin + '/dashboard-material.html');
                url.searchParams.set('openModal', 'investment');
                url.searchParams.set('accountType', 'ost');
                window.location.href = url.toString();
            }
        }

        function showOSTLearnMore() {
            showInfoModal(
                'OST Account Benefits',
                `<div class="info-content">
                    <h3>Finnish OST (Osakes√§√§st√∂tili) Benefits:</h3>
                    <ul>
                        <li><strong>Tax-Deferred Growth:</strong> No capital gains tax on investments within the account</li>
                        <li><strong>Annual Limit:</strong> ‚Ç¨50,000 contribution limit per year</li>
                        <li><strong>Withdrawal Tax:</strong> Only 15% tax on withdrawals after age 68</li>
                        <li><strong>Flexibility:</strong> Can hold stocks, ETFs, and mutual funds</li>
                        <li><strong>No Required Distributions:</strong> Unlike pensions, no mandatory withdrawals</li>
                    </ul>
                    <p class="highlight">Maximize your OST first for optimal tax efficiency!</p>
                </div>`
            );
        }

        function analyzeTaxLossHarvesting() {
            const data = taxCalculator.getInvestmentData();
            const aotInvestments = data.aotInvestments;
            
            // Calculate potential tax-loss harvesting opportunities
            const harvestingOpportunities = aotInvestments.map(investment => {
                const unrealizedGain = (investment.currentValue || investment.amount) - investment.amount;
                const percentageChange = (unrealizedGain / investment.amount) * 100;
                
                return {
                    ...investment,
                    unrealizedGain,
                    percentageChange,
                    harvestingPotential: unrealizedGain < 0 ? Math.abs(unrealizedGain) : 0
                };
            }).filter(inv => inv.harvestingPotential > 0)
              .sort((a, b) => b.harvestingPotential - a.harvestingPotential);

            let content = '<div class="analysis-content">';
            
            if (harvestingOpportunities.length === 0) {
                content += `
                    <p class="no-opportunities">üéâ Great news! No tax-loss harvesting opportunities found.</p>
                    <p>All your AOT investments are currently showing gains. Consider this analysis again during market downturns.</p>
                `;
            } else {
                const totalHarvestable = harvestingOpportunities.reduce((sum, inv) => sum + inv.harvestingPotential, 0);
                const taxSavings = totalHarvestable * 0.30; // 30% capital gains tax
                
                content += `
                    <h3>Tax-Loss Harvesting Analysis</h3>
                    <div class="analysis-summary">
                        <div class="summary-item">
                            <strong>Total Harvestable Loss:</strong> ‚Ç¨${totalHarvestable.toLocaleString()}
                        </div>
                        <div class="summary-item">
                            <strong>Potential Tax Savings:</strong> ‚Ç¨${taxSavings.toLocaleString()}
                        </div>
                    </div>
                    <h4>Underperforming Investments:</h4>
                    <div class="opportunities-list">
                `;
                
                harvestingOpportunities.forEach(inv => {
                    content += `
                        <div class="opportunity-item">
                            <div class="investment-info">
                                <strong>${inv.symbol || inv.type}</strong>
                                <span class="loss-amount">-‚Ç¨${inv.harvestingPotential.toLocaleString()}</span>
                                <span class="percentage">(${inv.percentageChange.toFixed(1)}%)</span>
                            </div>
                            <div class="harvest-actions">
                                <button class="md-button md-button-text" onclick="harvestLoss('${inv.symbol}')">Consider Selling</button>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div><p class="disclaimer">‚ö†Ô∏è Consider reinvestment rules and wash sale regulations before executing.</p>';
            }
            
            content += '</div>';
            
            showInfoModal('Tax-Loss Harvesting Analysis', content);
        }

        function showTaxLossLearnMore() {
            showInfoModal(
                'Tax-Loss Harvesting in Finland',
                `<div class="info-content">
                    <h3>How Tax-Loss Harvesting Works:</h3>
                    <ul>
                        <li><strong>Realize Losses:</strong> Sell underperforming investments to realize capital losses</li>
                        <li><strong>Offset Gains:</strong> Use losses to offset capital gains, reducing taxable income</li>
                        <li><strong>Tax Rate:</strong> Save 30% on capital gains tax through strategic loss realization</li>
                        <li><strong>Reinvestment:</strong> Consider similar (but not identical) investments to maintain exposure</li>
                        <li><strong>Timing:</strong> Best executed before year-end for maximum tax benefit</li>
                    </ul>
                    <div class="warning">
                        <strong>Important:</strong> Consult with a Finnish tax advisor before executing tax-loss harvesting strategies.
                    </div>
                </div>`
            );
        }

        function showDividendCalendar() {
            const now = new Date();
            const months = [];
            
            // Generate next 12 months of dividend calendar
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const isOptimal = (date.getMonth() + 1) % 3 === 0; // Every 3rd month for quarterly dividends
                
                months.push({
                    name: monthName,
                    optimal: isOptimal,
                    recommendation: isOptimal ? 'Optimal for dividend stock purchases' : 'Consider ETF accumulating shares'
                });
            }

            let content = `
                <div class="calendar-content">
                    <h3>Dividend Timing Optimization Calendar</h3>
                    <p>Strategic timing can help optimize tax efficiency across tax years:</p>
                    <div class="months-grid">
            `;
            
            months.forEach(month => {
                content += `
                    <div class="month-item ${month.optimal ? 'optimal' : ''}">
                        <div class="month-name">${month.name}</div>
                        <div class="month-recommendation">${month.recommendation}</div>
                        ${month.optimal ? '<span class="optimal-badge">‚úì Optimal</span>' : ''}
                    </div>
                `;
            });
            
            content += `
                    </div>
                    <div class="calendar-tips">
                        <h4>Tips for Dividend Timing:</h4>
                        <ul>
                            <li>Purchase dividend stocks before ex-dividend dates in optimal months</li>
                            <li>Consider accumulating ETFs to avoid dividend tax timing issues</li>
                            <li>Plan major stock purchases around dividend calendars</li>
                            <li>Monitor ex-dividend dates for Finnish and international stocks</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showInfoModal('Dividend Timing Calendar', content);
        }

        function showDividendLearnMore() {
            showInfoModal(
                'Dividend Tax Optimization',
                `<div class="info-content">
                    <h3>Finnish Dividend Taxation:</h3>
                    <ul>
                        <li><strong>Tax Rate:</strong> 30% on dividend income for most investors</li>
                        <li><strong>Timing Matters:</strong> Dividends are taxed in the year received</li>
                        <li><strong>Ex-Dividend Date:</strong> Purchase before this date to receive the dividend</li>
                        <li><strong>Accumulating ETFs:</strong> Reinvest dividends automatically, deferring tax</li>
                        <li><strong>Double Taxation Treaties:</strong> May reduce foreign dividend withholding</li>
                    </ul>
                    <div class="optimization-tip">
                        <strong>Pro Tip:</strong> Consider accumulating share classes (ISIN ending in 'EUR') to defer dividend taxation.
                    </div>
                </div>`
            );
        }

        // Generic info modal function
        function showInfoModal(title, content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('infoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'infoModal';
                modal.className = 'md-modal';
                modal.innerHTML = `
                    <div class="md-modal-overlay" onclick="closeInfoModal()"></div>
                    <div class="md-modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title" id="infoModalTitle"></h2>
                            <button class="md-icon-button" onclick="closeInfoModal()">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        <div class="modal-content" id="infoModalContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Set content and show
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalContent').innerHTML = content;
            modal.classList.add('open');
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.classList.remove('open');
            }
        }

        function harvestLoss(symbol) {
            alert(`Tax-loss harvesting for ${symbol} - Feature coming soon! This will help you execute strategic loss realization.`);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTaxAnalytics();
            
            // Update every 5 minutes to reflect any changes
            setInterval(updateTaxAnalytics, 300000);
        });

        // Scroll effects
        window.addEventListener('scroll', () => {
            const appBar = document.querySelector('.md-app-bar');
            if (window.scrollY > 0) {
                appBar.classList.add('md-elevation-4');
            } else {
                appBar.classList.remove('md-elevation-4');
            }
        });
    </script>
</body>
</html>